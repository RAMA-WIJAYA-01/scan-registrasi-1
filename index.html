<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Registrasi Peserta — Scan No Peserta</title>
  <style>
    :root { --gap: 12px; --radius: 14px; }
    html,body { height:100%; }
    body { margin:0; padding:20px; font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:#0f172a; color:#e2e8f0; }
    .wrap { max-width: 860px; margin: 0 auto; }
    .card { background:#111827; border:1px solid #1f2937; border-radius:var(--radius); box-shadow: 0 10px 30px rgba(0,0,0,.35); padding:18px; }
    h1 { font-size:22px; margin:0 0 12px; }
    .muted { opacity:.8; font-size:13px; margin-bottom:12px; }
    #preview { position: relative; height: 260px; border-radius:12px; overflow:hidden; background:#000; }
    #status { margin-top:10px; font-size:14px; }
    .ok { color:#34d399; } .warn { color:#fbbf24; } .err { color:#f87171; }
    .grid { display:grid; gap:var(--gap); grid-template-columns: 1fr 1fr; }
    .grid > * { min-width:0; }
    label { font-size:14px; display:block; margin:8px 0 6px; color:#cbd5e1; }
    input, button { width:100%; padding:10px 12px; border-radius:10px; border:1px solid #334155; background:#0b1220; color:#e5e7eb; outline:none; }
    input:focus { border-color:#60a5fa; }
    .row { display:flex; gap:var(--gap); align-items:center; } .row > * { flex:1; }
    button { cursor:pointer; background:#2563eb; border:none; font-weight:600; }
    button.secondary { background:#374151; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .footer { opacity:.7; font-size:12px; text-align:center; margin-top:10px; }
    @media (max-width: 720px) { .grid { grid-template-columns: 1fr; } }
    #preview .scan-box { position:absolute; inset:0; display:grid; place-items:center; pointer-events:none; }
    #preview .scan-box .box { width:220px; height:220px; border:2px solid #60a5fa; border-radius:10px; box-shadow:0 0 0 9999px rgba(0,0,0,.45); position:relative; }
    #preview .scan-box .box::before, #preview .scan-box .box::after { content:""; position:absolute; width:24px; height:24px; border:4px solid #60a5fa; }
    #preview .scan-box .box::before { border-right:0; border-bottom:0; top:-2px; left:-2px; border-radius:10px 0 0 0; }
    #preview .scan-box .box::after  { border-left:0; border-top:0; bottom:-2px; right:-2px; border-radius:0 0 10px 0; }
  </style>
  <script src="https://unpkg.com/html5-qrcode" defer></script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Registrasi Peserta (Scan No Peserta & Auto-Isi)</h1>
      <div class="muted">Arahkan kamera ke barcode/QR <b>No Peserta</b>. Jika ditemukan pada Master, form terisi otomatis.</div>

      <div id="preview">
        <div class="scan-box"><div class="box" id="scanBox"></div></div>
      </div>
      <div id="status" class="warn">Menginisialisasi kamera…</div>

      <form id="form" style="margin-top:16px">
        <div class="grid">
          <div><label>NAMA</label><input id="nama" required placeholder="Nama peserta" autocomplete="off"></div>
          <div><label>NIK</label><input id="nik" required placeholder="NIK" autocomplete="off"></div>
          <div><label>NO PESERTA (hasil scan)</label><input id="noPeserta" required placeholder="Nomor peserta" autocomplete="off"></div>
          <div><label>JADWAL</label><input id="jadwalTes" type="datetime-local" required></div>
        </div>
        <div class="row" style="margin-top:14px">
          <button id="btnSubmit" type="submit">Konfirmasi & Simpan</button>
          <button id="btnClear" type="button" class="secondary">Bersihkan</button>
        </div>
      </form>

      <div class="footer">Tersimpan: NAMA, NIK, NO PESERTA, JADWAL, LINK WHATSAPP, Timestamp (server).</div>
    </div>
  </div>

<script>
const GAS_URL = 'https://script.google.com/macros/s/AKfycbysFd_cwMh8fEImcb1W6N7d61BrDJ2yfCy_d17cDkq0KaqzXnHAhqgnoy71A3tcm2O3/exec'; // ganti dengan URL /exec

let scanner = null, lastDecoded = '';
const $ = (id) => document.getElementById(id);
const deviceInfo = () => (navigator.userAgent || 'unknown');
function setStatus(t,c=''){ const el=$('status'); el.className=c; el.textContent=t; }

async function startScanner(){
  try{
    const H = window.Html5Qrcode; if(!H){ setStatus('Gagal memuat library scanner.','err'); return; }
    scanner = new H("preview");
    const cams = await H.getCameras(); if(!cams?.length){ setStatus('Kamera tidak ditemukan.','err'); return; }
    const camId = cams.find(c=>/back|rear/i.test(c.label))?.id || cams[0].id;

    const preview = $('preview'), rect = preview.getBoundingClientRect();
    const size = Math.floor(Math.min(rect.width,rect.height)*0.75);
    const boxEl = $('scanBox'); boxEl.style.width=size+'px'; boxEl.style.height=size+'px';

    await scanner.start({deviceId:{exact:camId}}, {fps:10, qrbox:{width:size,height:size}},
      (text)=>{ if(text && text!==lastDecoded){ lastDecoded=text; onCodeDetected(text); } }, ()=>{});
    setStatus('Kamera aktif. Arahkan ke barcode No Peserta.','ok');

    window.addEventListener('resize', ()=>{
      const r=preview.getBoundingClientRect(); const s=Math.floor(Math.min(r.width,r.height)*0.75);
      boxEl.style.width=s+'px'; boxEl.style.height=s+'px';
    });
  }catch(e){ console.error(e); setStatus('Gagal mengakses kamera: '+e,'err'); }
}

async function onCodeDetected(noPeserta){
  $('noPeserta').value = noPeserta;
  setStatus('No Peserta terbaca: '+noPeserta+' • mencari data…','warn');
  try{
    const res = await fetch(`${GAS_URL}?action=lookup&code=${encodeURIComponent(noPeserta)}`);
    const json = await res.json();
    if(json.ok && json.found){
      const d=json.data||{};
      $('nama').value=d.nama||''; $('nik').value=d.nik||''; if(d.jadwalTes) $('jadwalTes').value=d.jadwalTes;
      setStatus('Data terisi otomatis dari Master Sheet.','ok');
    }else{
      setStatus('No Peserta tidak ditemukan di Master. Isi manual.','warn');
    }
  }catch(err){ console.error(err); setStatus('Gagal ambil data: '+err.message,'err'); }
}

$('form').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const btn=$('btnSubmit'); btn.disabled=true;
  const payload={
    nama:$('nama').value.trim(),
    nik:$('nik').value.trim(),
    noPeserta:$('noPeserta').value.trim(),
    jadwalTes:$('jadwalTes').value,
    device:deviceInfo()
  };
  if(!payload.nama||!payload.nik||!payload.noPeserta||!payload.jadwalTes){
    setStatus('Lengkapi semua field wajib.','err'); btn.disabled=false; return;
  }
  try{
    const res = await fetch(GAS_URL, {
      method:'POST',
      headers:{'Content-Type':'text/plain;charset=utf-8'}, // simple request (tanpa preflight)
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if(data.ok){
      const wa = encodeURIComponent(data.linkWa || '');  // ← link WA dari server (Master)
      const no = encodeURIComponent(payload.noPeserta);
      window.location.href = `success.html?no=${no}&wa=${wa}`;
    }else{
      throw new Error(data.error||'Unknown error');
    }
  }catch(err){ console.error(err); setStatus('Gagal menyimpan: '+err.message,'err'); }
  finally{ btn.disabled=false; }
});

$('btnClear').addEventListener('click', ()=>{ $('form').reset(); lastDecoded=''; setStatus('Form dibersihkan.','warn'); });
document.addEventListener('DOMContentLoaded', startScanner);
</script>
</body>
</html>
